{% extends "base.html" %}
{% load static %}
{% block content %}
{% if form.errors %}
    <div class="alert alert-danger" role="alert">
        <ul class="text-center">
            {% for field in form %}
                {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% if form.non_field_errors %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            {% endif %}
        </ul>
    </div>
{% endif %}

{% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}"{% endif %}>
                <p class="text-center"> {{ message }}</p>
            </div>
        {% endfor %}

        <!-- Start of Main -->
        <main class="main">
            <!-- Start of Breadcrumb -->
            <nav class="breadcrumb-nav">
                <div class="container">
                    <ul class="breadcrumb bb-no">
                        <li><a href="url">Home</a></li>
                        <li><a href="#">Vendor-{{vendor.company_name}}</a></li>
                    </ul>
                </div>
            </nav>
            <!-- End of Breadcrumb -->
            
            
            <!-- Start of Pgae Contetn -->
            <div class="page-content mb-8">
                <div class="container">
                    <div class="row gutter-lg">
                        <aside class="sidebar left-sidebar vendor-sidebar sticky-sidebar-wrapper sidebar-fixed">
                            <!-- Start of Sidebar Overlay -->
                            <div class="sidebar-overlay"></div>
                            <a class="sidebar-close" href="#"><i class="close-icon"></i></a>
                            <a href="#" class="sidebar-toggle"><i class="fas fa-chevron-right"></i></a>
                            <div class="sidebar-content">
                                <div class="sticky-sidebar">
                                    <form method="post">
                                        {% csrf_token %}
                                        <div class="widget widget-collapsible widget-contact">
                                            <h3 class="widget-title"><span>Contact Vendor</span></h3>
                                            <div class="widget-body">
                                                {{form.name}}
                                                {{form.email}}
                                                {{form.message}}
                                                <input type="hidden" name="form_type" value="contact_vendor">
                                                <button type="submit" class="btn btn-dark btn-rounded">Send Message</button>
                                            </div>
                                            

                                        </div>
                                        <!-- End of Widget -->
                                    </form>    
                               
                                    <div class="widget widget-collapsible widget-products">
                                        <h3 class="widget-title"><span>Top Rated</span></h3>
                                        <div class="widget-body">
                                            {% for product in top_rated_products %}
                                            <div class="product product-widget">
                                                <figure class="product-media">
                                                    <a href="{% url 'product-detail' product.slug %}">
                                                        <img src="{{product.image.url}}" alt="Product" width="100"
                                                            height="106" />
                                                    </a>
                                                </figure>
                                                <div class="product-details">
                                                    <h4 class="product-name">
                                                        <a href="{% url 'product-detail' product.slug %}">{{product.name|title|truncatewords:3}}</a>
                                                    </h4>
                                                    <div class="ratings-container">
                                                        <div class="ratings-full">
                                                            <span class="ratings" style="width: {{product.avg_rating_percentage}}%;"></span>
                                                            <span class="tooltiptext tooltip-top"></span>
                                                        </div>
                                                    </div>
                                                    {% if product.discount %}
                                                    <div class="product-price ">₦ {{product.price}} <p class="product-price text-decoration-line-through ms-4">₦ {{product.discounted_price}}</p></div> 
                                                    {% else %}
                                                    <div class="product-price">₦ {{product.price}}</div>
                                                    {% endif %}
                                                    {% if product.stock == 0 %}<p class="fs-6 text-danger-emphasis">Out Of Stock</p>{% endif %}

                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <!-- End of Widget -->
                                </div>
                            </div>
                        </aside>
                        <!-- End of Sidebar -->

                        <div class="main-content">
                            <div class="store store-banner mb-4">
                                <figure class="store-media">
                                    <img src="{% static 'images/vendor.jpg' %}" alt="Vendor" width="930" height="446"
                                        style="background-color: #414960;" />
                                </figure>
                                <div class="store-content">
                                    <figure class="seller-brand">
                                        <img src="{{vendor.company_logo.url}}" alt="Brand" width="100"
                                            height="100" />
                                    </figure>
                                    <h4 class="store-title">{{vendor.company_name|title}}</h4>
                                    <ul class="seller-info-list list-style-none mb-6">
                                        
                                        <li class="store-rating">
                                            <i class="w-icon-star-full"></i>
                                            {{avg_rating}} rating from {{reviews_total}} review(s)
                                        </li>
                                        <li class="store-open">
                                            <i class="w-icon-cart"></i>
                                            {{vendor.company_category}}
                                        </li>
                                    </ul>
                                    
                                </div>
                            </div>
                            <!-- End of Store Banner -->
                            <div class="main-content">
                                <div class="tab tab-nav-underline tab-nav-boxed tab-vendor-wcfm">
                                    <ul class="nav nav-tabs">
                                        <li class="nav-item">
                                            <a href="#tab-1" class="nav-link active">Products</a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="#tab-2" class="nav-link">About</a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="#tab-3" class="nav-link">Policies</a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="#tab-4" class="nav-link">Reviews({{ratings_count}})</a>
                                        </li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane active" id="tab-1">
                                            <nav class="toolbox sticky-toolbox sticky-content fix-top">
                                                <div class="toolbox-left">
                                                    <div class="toolbox-item toolbox-sort select-box text-dark">
                                                        <label>Sort By :</label>
                                                        <select id="sort" name="orderby" class="form-control">
                                                            <option value="" {% if sort_option == '' %}selected{% endif %}>Default Sorting</option>
                                                            <option value="rating" {% if sort_option == 'rating' %}selected{% endif %}>Sort by average rating</option>
                                                            <option value="price_asc" {% if sort_option == 'price_asc' %}selected{% endif %}>Sort by price: low to high</option>
                                                            <option value="price_desc" {% if sort_option == 'price_desc' %}selected{% endif %}>Sort by price: high to low</option>
                                                        </select>
                                                        <script>
                                                            document.getElementById('sort').addEventListener('change', function() {
                                                                const selectedSort = this.value;
                                                                const urlParams = new URLSearchParams(window.location.search);
                                                        
                                                                if (selectedSort) {
                                                                    urlParams.set('sort', selectedSort);
                                                                } else {
                                                                    urlParams.delete('sort');  // Remove the sort param if "No Sorting" is selected
                                                                }
                                                        
                                                                window.location.search = urlParams.toString();
                                                            });
                                                        </script>
                                                    </div>
                                                </div>
                                                
                                            </nav>
                                            <div class="product-wrapper row cols-md-3 cols-sm-2 cols-2">
                                                {% for product in products %}
                                                <div class="product-wrap">
                                                    <div class="product text-center">
                                                        <figure class="product-media">
                                                            <a href="{% url 'product-detail' product.slug %}">
                                                                <img src="{{product.image.url}}" alt="Product"
                                                                    />
                                                            </a>
                                                            <div class="product-action-vertical">
                                                                {% if product.stock != 0 %}
                                                                <a href="{% url 'add_to_cart' product.slug %}"><button class="btn-product-icon w-icon-cart" title="cart">
                                                                </button></a>
                                                                {% endif %}
                                                                <a href="{% url 'add-to-wishlist' product.slug %}" class="btn-product-icon  w-icon-heart"
                                                                    title="Wishlist"></a>
                                                            </div>
                                                            
                                                        </figure>
                                                        <div class="product-details">
                                                            <h3 class="product-name">
                                                                <a href="{% url 'product-detail' product.slug %}">{{product.name}}</a>
                                                            </h3>
                                                            <div class="ratings-container">
                                                                <div class="ratings-full">
                                                                    <span class="ratings" style="width: {{product.avg_rating_percentage}}%;"></span>
                                                                    <span class="tooltiptext tooltip-top"></span>
                                                                </div>
                                                                <a href="#" class="rating-reviews">({{product.total_reviews}}{% if not product.total_reviews == 1 %} reviews {% else %} review {% endif %})</a>
                                                            </div>
                                                            {% if product.discount %}
                                                            <div class="product-pa-wrapper">
                                                                <div class="product-price">
                                                                    <p>₦ {{product.discounted_price}}</p> <p class="text-decoration-line-through">₦ {{product.price}}</P> 
                                                                </div>
                                                            </div>
                                                            {% else %}
                                                            <div class="product-pa-wrapper">
                                                                <div class="product-price">
                                                                    ₦ {{product.price}}
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            {% if product.stock == 0 %}<p class="fs-2 text-danger-emphasis">Out Of Stock</p>{% endif %}
    
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <div class="toolbox toolbox-pagination justify-content-between">
                                                <ul class="pagination">
                                                    {% if products.has_previous %}
                                                    <li class="prev disabled">
                                                        <a href="?page={{products.previous_page_number}}&category={{ selected_category }}&state={{ selected_state }}" aria-label="Previous" tabindex="-1" aria-disabled="true">
                                                            <i class="w-icon-long-arrow-left"></i>Prev
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    {% for page in products.paginator.page_range %}
                                                    <li class="page-item active">
                                                        <a class="page-link" href="?page={{ page }}&category={{ selected_category }}&state={{ selected_state }}&sort={{ sort_option }}">{{ page }}</a>
                                                    </li>
                                                    {% endfor %}
                                                    {% if products.has_next %}
                                                    <li class="next">
                                                        <a href="?page={{products.next_page_number}}&category={{ selected_category }}&state={{ selected_state }}&sort={{ sort_option }}" aria-label="Next">
                                                            Next<i class="w-icon-long-arrow-right"></i>
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="tab-2">
                                            <p class="mb-4">{{vendor.company_description}}</p>
                                        </div>
                                        <div class="tab-pane" id="tab-3">
                                            <div class="policies-area">
                                                <h3 class="title">Shipping Policy</h3>
                                                <p><strong>L</strong>orem ipsum dolor sit amet, consectetur adipiscing elit,
                                                    sed do eiusmod tempor incididunt arcu cursus. Sagittis id consectetur
                                                    purus
                                                    ut. Tellus rutrum tellus pelle.</p>
                                            </div>
                                            <div class="policies-area">
                                                <h3 class="title">Refund Policy</h3>
                                                <p><strong>L</strong>orem ipsum dolor sit amet, consectetur adipiscing elit,
                                                    sed do eiusmod tempor incididunt arcu cursus. Sagittis id consectetur
                                                    purus ut. Tellus rutrum tellus pelle.</p>
                                            </div>
                                            <div class="policies-area">
                                                <h3 class="title text-left">Cancellation / Return / Exchange Policy</h3>
                                                <p><strong>L</strong>orem ipsum dolor sit amet, consectetur adipiscing elit,
                                                    sed do eiusmod tempor incididunt arcu cursus. Sagittis id consectetur
                                                    purus ut. Tellus rutrum tellus pelle.</p>
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="tab-4">
                                            
                                            <div class="review-area">
                                                <h3 class="title font-weight-bold mb-5">Reviews</h3>
                                                {% for rating in ratings  %}
                                              
                                                <!-- End of Review Ratings -->
                                                <div class="user-wrap">
                                                    <div class="user-photo">
                                                       
                                                        <div class="rated text-center">
                                                            <label>Rated</label>
                                                            <span class="score">{{rating.review_stars}}</span>
                                                        </div>
                                                    </div>
                                                    <!-- End of User Photo -->
                                                    <div class="user-info">
                                                        <h4 class="user-name">{{rating.name}}</h4>
                                                        <div class="user-date mb-4">
                                                            <span>{{rating.date}}</span>
                                                        </div>
                                                        <p>{{rating.review|capfirst}}
                                                        </p>
                                                        <hr>
                                                    </div>
                                                    <!-- End of User Info -->
                                                    <div class="review-ratings">
                                                        <div class="ratings-container">
                                                            <div class="ratings-full">
                                                                <span class="ratings" style="width: {{rating.percentage}}%;"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <hr>
                                                </div>
                                                <!-- End of User Wrap -->
                                                {% endfor %}
                                            </div>
                                            <!-- End of Reveiw Area -->
                                            <div class="review-area">
                                                <h3 class="title font-weight-bold mb-5">Write A Review</h3>
                                                <form  method="POST" class="review-form" novalidate>
                                                    {% csrf_token %}
                                                        
                                                        
                                                    <div class=" mt-1 rating-form">
                                                        <span class="rating-stars" >
                                                            <a class="star-1" href="#" data-value="1">&#9733;</a> <!-- Updated to show star icon -->
                                                            <a class="star-2" href="#" data-value="2">&#9733;</a>
                                                            <a class="star-3" href="#" data-value="3">&#9733;</a>
                                                            <a class="star-4" href="#" data-value="4">&#9733;</a>
                                                            <a class="star-5" href="#" data-value="5">&#9733;</a>
                                                        </span>
                                                    </div>
                                                    <div class="invalid-feedback">
                                                        Please select a star
                                                    </div>
                                                    {{rating_form.review_stars}}
                                                    <div class="widget widget-collapsible widget-contact mb-10">
                                                        <div class="widget-body">
                                                            {{rating_form.name}}
                                                            {{rating_form.email}}
                                                            {{rating_form.review}}
                                                            <input type="hidden" name="form_type" value="vendor_rating">
                                                            <button type="submit" class="btn btn-dark btn-rounded">Send Review</button>
                                                        </div>
                                                    </div>
                                                </form>
                                                <script>
                                                    document.addEventListener('DOMContentLoaded', function () {
                                                        const form = document.querySelector('.review-form');
                                                        const ratingInput = document.querySelector('input#rating');
                                                    
                                                        form.addEventListener('submit', function (e) {
                                                            if (!ratingInput.value) {
                                                                e.preventDefault();
                                                                alert('Please provide a rating before submitting.');
                                                            }
                                                        });
                                                    
                                                        const stars = document.querySelectorAll('.rating-stars a');
                                                        stars.forEach(star => {
                                                            star.addEventListener('click', function (e) {
                                                                e.preventDefault();
                                                                const ratingValue = this.dataset.value;
                                                                ratingInput.value = ratingValue;
                                                    
                                                                stars.forEach(s => s.classList.remove('active'));
                                                                for (let i = 0; i < ratingValue; i++) {
                                                                    stars[i].classList.add('active');
                                                                }
                                                            });
                                                        });
                                                    });
                                                    
            
                                                </script>
                                            </div>
                                            <!-- End of Reveiw Area -->
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                        <!-- End of Main Content -->
                    </div>
                </div>
            </div>
            <!-- End of Page Content -->
            
        </main>
        <!-- End of Main -->
{% endblock content %}